---
- name: Get meilisearch keys
  include_role:
    name: joeosborn.meilisearch
    tasks_from: fetch_keys
- name: Create gisst_server group
  ansible.builtin.group:
    name: "{{ gisst_server_group }}"
    system: true
    state: present
- name: Create gisst_server user
  ansible.builtin.user:
    name: "{{ gisst_server_user }}"
    group: "{{ gisst_server_group }}"
    system: true
    create_home: true
    home: "{{ gisst_server_home }}"
    shell: /sbin/nologin
    state: present
- name: Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ gisst_server_user }}"
    group: "{{ gisst_server_group }}"
    mode: '0755'
  loop:
    - "{{ gisst_server_config_dir }}"
    - "{{ gisst_server_config_dir }}/config"
    - "{{ gisst_server_storage_dir }}"
    - "{{ gisst_server_temp_dir }}"
- name: Install node dependency for v86dump
  include_role:
    name: geerlingguy.nodejs
  vars:
    nodejs_version: "23.x"
    nodejs_install_npm_user: "{{ gisst_server_user }}"
- name: Establish gisst server directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ gisst_server_home }}"
    - "{{ gisst_server_home }}"
    - "{{ gisst_server_config_dir }}"
- name: Get gisst server (dev)
  block:
    - name: Download development dependencies
      apt:
        state: latest
        update_cache: yes
        name:
          - git
          - cargo
    - name: Checkout GISST branch (dev)
      git:
        repo: 'https://github.com/shftgroup/gisst'
        dest: "{{ gisst_server_home }}/release"
        version: "{{ gisst_server_version }}"
      notify: Rebuild gisst-server
  when: gisst_server_environment == "development"
- name: Get gisst server (testing, production)
  block:
    - name: Determine system architecture
      ansible.builtin.set_fact:
        gisst_server_arch: "{{ 'X64' if ansible_architecture == 'x86_64' else 'aarch64' if ansible_architecture == 'aarch64' else ansible_architecture }}"
    - name: Check if gisst-server binary exists
      ansible.builtin.stat:
        path: "{{ gisst_server_home }}/gisst-server"
      register: gisst_server_binary
    - name: Get current gisst-server version
      ansible.builtin.command:
        cmd: "{{ gisst_server_home }}/gisst-server --version"
      register: gisst_server_current_version
      failed_when: false
      changed_when: false
      when: gisst_server_binary.stat.exists
    - name: Extract current version number
      ansible.builtin.set_fact:
        gisst_server_current_version_number: "{{ gisst_server_current_version.stdout | regex_search('gisst-server ([0-9]+\\.[0-9]+\\.[0-9]+)', '\\1') | first }}"
      when:
        - gisst_server_binary.stat.exists
        - gisst_server_current_version.rc == 0
        - gisst_server_current_version.stdout is defined
    - name: Set current version to empty when binary doesn't exist or version check failed
      ansible.builtin.set_fact:
        gisst_server_current_version_number: ""
      when: >
        not gisst_server_binary.stat.exists or
        gisst_server_current_version.rc != 0 or
        gisst_server_current_version.stdout is not defined
    - name: Extract desired version number
      ansible.builtin.set_fact:
        gisst_server_desired_version_number: "{{ gisst_server_version | regex_replace('^v', '') }}"
    - name: Download gisst-server binaries
      ansible.builtin.get_url:
        url: "https://github.com/shftgroup/gisst/releases/download/{{ gisst_server_version }}/{{ item }}"
        dest: "{{ gisst_server_home }}/{{ item | split('-linux') | first }}"
        mode: '0755'
        owner: root
        group: root
        timeout: 120
      loop:
        - "gisst-server-linux-{{ gisst_server_arch }}"
        - "gisst-cli-linux-{{ gisst_server_arch }}"
        - "ingest-linux-{{ gisst_server_arch }}"
        - "v86dump.js"
        - "frontend-assets.tgz"
      when: >
        not gisst_server_binary.stat.exists or
        (gisst_server_binary.stat.exists and
         gisst_server_current_version_number != gisst_server_desired_version_number)
      notify: Restart gisst-server
      retries: 3
      delay: 10
    - name: Untar frontend assets
      ansible.builtin.unarchive:
        src: "{{ gisst_server_home }}/frontend-assets.tgz"
        dest: "{{ gisst_server_config_dir }}"
        remote_src: yes
    - name: (Temporary) Copy v86dump.js
      copy:
        src: "{{ gisst_server_home }}/v86dump.js"
        dest: "{{ gisst_server_config_dir }}/v86dump.js"
        remote_src: yes
    - name: Download default.toml file
      ansible.builtin.get_url:
        url: "https://github.com/shftgroup/gisst/blob/{{ gisst_server_version }}/backend/config/default.toml"
        dest: "{{ gisst_server_config_dir }}/config/default.toml"
        mode: '0644'
        owner: "{{ gisst_server_user }}"
        group: "{{ gisst_server_group }}"
        timeout: 120
      notify: Restart gisst-server
      retries: 3
      delay: 10
  when: gisst_server_environment != "development"
- name: Deploy gisst env file
  template:
    src: gisst-server.env.j2
    dest: "{{ gisst_server_config_dir }}/gisst-server.env"
    owner: "{{ gisst_server_user }}"
    group: "{{ gisst_server_user }}"
    mode: '0640'
- name: Deploy gisst configuration
  template:
    src: gisst-server.config.toml.j2
    dest: "{{ gisst_server_config_dir }}/config/local.toml"
    owner: "{{ gisst_server_user }}"
    group: "{{ gisst_server_user }}"
    mode: '0640'
- name: Deploy systemd service file
  ansible.builtin.template:
    src: gisst-server.service.j2
    dest: /etc/systemd/system/gisst-server.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Reload systemd
    - Restart gisst-server
- name: Start and enable gisst-server service
  ansible.builtin.systemd_service:
    name: gisst-server
    state: started
    enabled: true
    daemon_reload: true
- name: Flush handlers before health check
  ansible.builtin.meta: flush_handlers
- name: Check for gisst-server response
  ansible.builtin.uri:
    url: "{{ gisst_server_base_url }}"
    method: HEAD
    return_content: false
    status_code: 200
  register: gisst_server_health_check
  retries: 5
  delay: 10
  until: gisst_server_health_check.status == 200
