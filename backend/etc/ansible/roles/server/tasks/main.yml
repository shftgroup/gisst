---
- name: Create gisst_server group
  ansible.builtin.group:
    name: "{{ gisst_server_group }}"
    system: true
    state: present
- name: Create gisst_server user
  ansible.builtin.user:
    name: "{{ gisst_server_user }}"
    group: "{{ gisst_server_group }}"
    system: true
    create_home: true
    home: "{{ gisst_server_home }}"
    shell: /sbin/nologin
    state: present
- name: Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ gisst_server_user }}"
    group: "{{ gisst_server_group }}"
    mode: '0755'
  loop:
    - "{{ gisst_server_config_dir }}"
    - "{{ gisst_server_storage_dir }}"
    - "{{ gisst_server_temp_dir }}"
- name: Install node dependency for v86dump
  include_role:
    name: geerlingguy.nodejs
  vars:
    nodejs_version: "23.x"
    nodejs_install_npm_user: "{{ gisst_server_user }}"
- name: Establish gisst server directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ gisst_server_home }}"
    - "{{ gisst_server_home }}"
    - "{{ gisst_server_config_dir }}"
- name: Get gisst server (dev)
  when: gisst_server_environment == "development"
  block:
    - name: Download development dependencies
      apt:
        - git
        - cargo
    - name: Checkout GISST branch (dev)
      git:
        repo: 'https://github.com/shftgroup/gisst'
        dest: "{{ gisst_server_home }}/release"
        version: "{{ gisst_server_version }}"
    - name: Build GISST binaries (dev)
      command:
        chdir: "{{ gisst_server_home }}/release/backend"
        cmd: "cargo build --all-targets --features {{ gisst_server_dev_cargo_features }}"
        creates:
          - "{{ gisst_server_home }}/release/backend/target/debug/gisst-cli"
          - "{{ gisst_server_home }}/release/backend/target/debug/gisst-server"
          - "{{ gisst_server_home }}/release/backend/target/debug/ingest"
    - name: Copy GISST binaries
      copy:
        src: "{{ item }}"
        dest: "{{ gisst_server_home }}/"
      loop:
          - "{{ gisst_server_home }}/release/backend/target/debug/gisst-cli"
          - "{{ gisst_server_home }}/release/backend/target/debug/gisst-server"
          - "{{ gisst_server_home }}/release/backend/target/debug/ingest"
          - "{{ gisst_server_home }}/release/backend/v86dump"
- name: Get gisst server (testing, production)
  when: gisst_server_environment != "development"
  block:
    - name: Determine system architecture
      ansible.builtin.set_fact:
        gisst_server_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'aarch64' if ansible_architecture == 'aarch64' else ansible_architecture }}"
    - name: Check if gisst-server binary exists
      ansible.builtin.stat:
        path: "{{ gisst_server_home }}/gisst-server"
      register: gisst_server_binary
    - name: Get current gisst-server version
      ansible.builtin.command:
        cmd: "{{ gisst_server_home }}/gisst-server --version"
      register: gisst_server_current_version
      failed_when: false
      changed_when: false
      when: gisst_server_binary.stat.exists
    - name: Extract current version number
      ansible.builtin.set_fact:
        gisst_server_current_version_number: "{{ gisst_server_current_version.stdout | regex_search('gisst-server ([0-9]+\\.[0-9]+\\.[0-9]+)', '\\1') | first }}"
      when:
        - gisst_server_binary.stat.exists
        - gisst_server_current_version.rc == 0
        - gisst_server_current_version.stdout is defined
    - name: Set current version to empty when binary doesn't exist or version check failed
      ansible.builtin.set_fact:
        gisst_server_current_version_number: ""
      when: >
        not gisst_server_binary.stat.exists or
        gisst_server_current_version.rc != 0 or
        gisst_server_current_version.stdout is not defined
    - name: Extract desired version number
      ansible.builtin.set_fact:
        gisst_server_desired_version_number: "{{ gisst_server_version | regex_replace('^v', '') }}"
    - name: Download gisst-server binaries
      ansible.builtin.get_url:
        url: "https://github.com/shftgroup/gisst/releases/download/{{ gisst_server_version }}/{{ item }}"
        dest: "{{ gisst_server_home }}"
        mode: '0755'
        owner: root
        group: root
        timeout: 120
      loop:
        - "gisst-server-linux-{{ gisst_server_arch }}"
        - "gisst-cli-linux-{{ gisst_server_arch }}"
        - "ingest-linux-{{ gisst_server_arch }}"
        - "v86dump.js"
      when: >
        not gisst_server_binary.stat.exists or
        (gisst_server_binary.stat.exists and
         gisst_server_current_version_number != gisst_server_desired_version_number)
      notify: Restart gisst_server
      retries: 3
      delay: 10
- name: Deploy systemd service file
  ansible.builtin.template:
    src: gisst-server.service.j2
    dest: /etc/systemd/system/gisst-server.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Reload systemd
    - Restart meilisearch
- name: Start and enable gisst-server service
  ansible.builtin.systemd_service:
    name: gisst-server
    state: started
    enabled: true
    daemon_reload: true
- name: Flush handlers before health check
  ansible.builtin.meta: flush_handlers
- name: Wait for Meilisearch service to be ready
  ansible.builtin.wait_for:
    host: "{{ meilisearch_http_addr.split(':')[0] }}"
    port: "{{ meilisearch_http_addr.split(':')[1] | int }}"
    delay: 5
    timeout: 60
    state: started

- name: Check Meilisearch health endpoint
  ansible.builtin.uri:
    url: "{{ meilisearch_http_proto }}://{{ meilisearch_http_addr }}/health"
    method: GET
    return_content: true
    status_code: 200
  register: meilisearch_health_check
  retries: 5
  delay: 10
  until: meilisearch_health_check.status == 200

- name: Verify health check response
  ansible.builtin.assert:
    that:
      - meilisearch_health_check.json is defined
      - meilisearch_health_check.json.status == "available"
    fail_msg: "Meilisearch health check failed: {{ meilisearch_health_check.content | default('No response content') }}"
    success_msg: "Meilisearch is healthy and available"
